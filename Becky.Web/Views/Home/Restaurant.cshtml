@model Becky.Web.Models.RestaurantModel
@{
    ViewBag.Title = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="jumbotron">
    <h3>@Model.Name</h3>
    <p>
        @Model.AddressLine1<br />
        @Model.AddressLine2
    </p>
    <p><span class="glyphicon glyphicon-phone-alt"></span>: @Model.Phone</p>
    <p><span class="glyphicon glyphicon-globe"></span>: @Model.Website</p>
    <div class="panel-body row" data-bind="foreach: restaurantPhotos">
        <div class="col-sm-3 col-md-2">
            <img data-bind="attr:{src: PhotoSource ? PhotoSource : '../../Images/Becky - No Image Icon.png' }" class="img img-responsive img-rounded fix-height" />
        </div>
    </div> 
    @*https://github.com/kartik-v/bootstrap-star-rating*@
    <input id="input-id" type="number" class="rating" step="1" data-size="xs" />
    <p>
        <input id="txtRestaurantReviewTitle" class="form-control" placeholder="Review title"/>
        <textarea id="txtRestaurantReview" class="form-control" rows="3" placeholder="Detailed review"></textarea>
    </p>
    <p>
        <button id="btnPost" class="btn btn-primary">Post Review</button>
        <button class="btn btn-default">Cancel</button>
    </p>
</div>
<div class="panel panel-default">
    <div class="panel panel-heading">
        <h3>Recent reviews</h3>
    </div>
    <div class="panel panel-body" data-bind="foreach: restaurantReviews">
        <div class="row">
            <div class="col-sm-3 col-md-2">
                <p><img data-bind="attr:{src: ProfilePictureUrl ? ProfilePictureUrl : '../../Images/Becky - No Image Icon.png' }" class="img img-responsive img-rounded fix-height-profile-picture" alt="" /></p>
                <p><span data-bind="text: ReviewerFullName"></span></p>
                <p><span data-bind="text: formatDate(ReviewedOn)"></span></p>
            </div>
            <div class="col-sm-15 col-md-10">
                <h4><span data-bind="text: ReviewTitle"></span></h4>
                @*<i>[#No of people found this useful]</i>*@
                <p><span data-bind="text: ReviewText"></span></p>
                @*<p>Was this review useful? <button type="button" class="btn btn-success"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span></button></p>*@
            </div>
        </div>
    </div>
</div>
<div class="panel panel-default">
    <div class="panel panel-heading">
        <h3>Similar restaurants</h3>
    </div>
    <div class="panel panel-body">
        Similar restaurants
    </div>
</div>
@section scripts
{
    <style type="text/css">
        .fix-height {
            height: 100px;
            background-size: contain;
        }
        .fix-height-profile-picture {
            height: 50px;
            background-size: contain;
        }
    </style>
    <script type="text/javascript">
        var restaurantId = @Model.Id;
        var uriRestaurant = '/Home/GetRestaurant';
        var uriRestaurantReviews = '/Home/GetRestaurantReviews';
        var uriRestaurantPhotos = '/Home/GetRestaurantPhotos';
        var uriRelatedRestaurants = '/Home/GetRelatedRestaurants';
        var uriPostRestaurantReview = '/Home/PostRestaurantReview';

        var viewModel = {
            restaurantRating: ko.observable(),

            restaurantReviews: ko.observableArray([]),
            restaurantPhotos: ko.observableArray([]),
            relatedRestaurants: ko.observableArray([])
        };

        function getRestaurantReviews() {
            $.postJSON(uriRestaurantReviews + '/' + restaurantId)
                .done(function(data) {
                    viewModel.restaurantReviews(data);
                });
        }

        function getRestaurantPhotos() {
            $.postJSON(uriRestaurantPhotos + '/' + restaurantId)
                .done(function(data) {
                    viewModel.restaurantPhotos(data);
                });
        }

        function getRelatedRestaurants() {
            $.postJSON(uriRelatedRestaurants + '/' + restaurantId)
                .done(function(data) {
                    viewModel.relatedRestaurants(data);
                });
        }

        //function postRestaurantRating() {
        //    $.postJSON(uriPostRestaurantRating + '/' + restaurantId)
        //        .done(function() {
        //            viewModel.relatedRestaurants(data);
        //        });
        //}

        //viewModel.restaurantRating.subscribe(function () {
        //    postRestaurantRating();
        //});

        function formatDate(rawDate) {
            return moment(parseInt(rawDate.substr(6))).format("Do MMMM YYYY");
        }

        $('#btnPost').click(function() {
            var restaurantReview = {
                RestaurantBranchId: restaurantId,
                ReviewText: $('#txtRestaurantReview').val(),
                ReviewTitle: $('#txtRestaurantReviewTitle').val()
            };

            console.log(restaurantReview);
            $.postJSON(uriPostRestaurantReview, restaurantReview)
                .done(function() {
                    console.log('in');
                    getRestaurantReviews();
                });
        });

        getRestaurantReviews();

        $('#input-id').rating('refresh', {disabled: false, showClear: false, showCaption: false});
        $('#input-id').on('rating.change', function(event, value, caption) {
            restaurantRating(value);
        });

        ko.applyBindings(viewModel);
    </script>
}
